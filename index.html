<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Gastos Inteligente</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --color-primario: #2c3e50;
      --color-secundario: #007bff;
      --fondo: #f8f9fa;
    }
    body {
      font-family: 'Arial', sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: var(--fondo);
    }
    .hidden { display: none; }
    .topbar {
      background: var(--color-primario);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    button {
      background: var(--color-secundario);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { opacity: 0.9; }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px;
      border: 1px solid #eee;
      text-align: left;
    }
    th { background: var(--fondo); }
    .acciones button { margin: 0 5px; padding: 5px 10px; }
    .alerta {
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      display: none;
    }
    .error { background: #ffebee; color: #d32f2f; }
    .exito { background: #e8f5e9; color: #2e7d32; }
  </style>
</head>
<body>
  <!-- Pantalla de Acceso -->
  <div id="login">
    <h2>üîê Acceso al Sistema</h2>
    <form onsubmit="event.preventDefault(); verificarPIN()">
      <input type="password" id="inputPIN" placeholder="Ingresa el PIN (5351)" required>
      <button type="submit">Ingresar</button>
    </form>
    <div id="mensajeError" class="alerta error"></div>
  </div>

  <!-- Aplicaci√≥n Principal -->
  <div id="app" class="hidden">
    <div class="topbar">
      <button onclick="mostrarSeccion('usuarios')">üë• Usuarios</button>
      <button onclick="mostrarSeccion('conceptos')">üóÉÔ∏è Conceptos</button>
      <button onclick="mostrarSeccion('gastos')">üíµ Gastos</button>
    </div>

    <!-- Gesti√≥n de Usuarios -->
    <div id="seccionUsuarios" class="seccion">
      <h3>Administraci√≥n de Usuarios</h3>
      <div class="formulario">
        <input type="text" id="nuevoUsuario" placeholder="Nombre completo">
        <button onclick="agregarUsuario()">‚ûï Crear Usuario</button>
      </div>
      <div id="listaUsuarios" class="lista"></div>
    </div>

    <!-- Gesti√≥n de Conceptos -->
    <div id="seccionConceptos" class="seccion hidden">
      <h3>Cat√°logo de Conceptos</h3>
      <div class="formulario">
        <input type="text" id="nuevoConcepto" placeholder="Ej: Alimentaci√≥n">
        <button onclick="agregarConcepto()">‚ûï Nuevo Concepto</button>
      </div>
      <div id="listaConceptos" class="lista"></div>
    </div>

    <!-- Registro de Gastos -->
    <div id="seccionGastos" class="seccion hidden">
      <h3>Registro de Gastos Inteligente</h3>
      <div class="formulario">
        <textarea id="descripcionGasto" placeholder="Ej: 'Compr√© medicinas por $150 pesos en la farmacia'" rows="3"></textarea>
        <button onclick="procesarGasto()">üß† Analizar y Guardar</button>
      </div>
      <div id="mensajeExito" class="alerta exito"></div>
      <h4>Historial de Gastos</h4>
      <table id="tablaGastos">
        <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Detalle</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
// ================= CONFIGURACI√ìN FIREBASE ================= //
const firebaseConfig = {
  apiKey: "AIzaSyC6UgYa0Qb2TTuvlpxU6nEru4LYKUMu8pQ",
  authDomain: "gastospersonales-96004.firebaseapp.com",
  projectId: "gastospersonales-96004",
  storageBucket: "gastospersonales-96004.appspot.com",
  messagingSenderId: "243343663938",
  appId: "1:243343663938:web:3482c365b6ce580e3cb969"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(app);
const OPENAI_API_KEY = "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";
let usuarioSeleccionado = "";

// ================= FUNCIONES PRINCIPALES ================= //
function verificarPIN() {
  const pin = document.getElementById("inputPIN").value;
  const mensajeError = document.getElementById("mensajeError");
  
  if (pin === "5351") {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    mostrarSeccion('usuarios');
  } else {
    mensajeError.textContent = "‚ùå PIN incorrecto. Intenta nuevamente.";
    mensajeError.style.display = 'block';
  }
}

function mostrarSeccion(seccion) {
  document.querySelectorAll('.seccion').forEach(div => div.classList.add('hidden'));
  document.getElementById(`seccion${seccion.charAt(0).toUpperCase() + seccion.slice(1)}`).classList.remove('hidden');
  if (seccion === 'usuarios') cargarUsuarios();
  if (seccion === 'conceptos') cargarConceptos();
  if (seccion === 'gastos') cargarGastos();
}

// ================= FUNCIONES DE USUARIOS ================= //
async function agregarUsuario() {
  const nombre = document.getElementById("nuevoUsuario").value.trim();
  const mensajeError = document.getElementById("mensajeError");
  
  if (!nombre) {
    mensajeError.textContent = "‚ö†Ô∏è Escribe un nombre v√°lido";
    mensajeError.style.display = 'block';
    return;
  }

  try {
    await db.collection("usuarios").add({ nombre });
    document.getElementById("nuevoUsuario").value = "";
    mostrarMensaje("‚úÖ Usuario creado exitosamente", 'exito');
    cargarUsuarios();
  } catch (error) {
    manejarError(`‚ùå Error al crear usuario: ${error.message}`);
  }
}

async function cargarUsuarios() {
  try {
    const snapshot = await db.collection("usuarios").get();
    const lista = document.getElementById("listaUsuarios");
    lista.innerHTML = snapshot.docs.map(doc => `
      <div class="item">
        <span>${doc.data().nombre}</span>
        <div class="acciones">
          <button onclick="editarUsuario('${doc.id}', '${doc.data().nombre}')">‚úèÔ∏è</button>
          <button onclick="eliminarUsuario('${doc.id}')">üóë</button>
          <button onclick="seleccionarUsuario('${doc.data().nombre}')">‚úîÔ∏è</button>
        </div>
      </div>
    `).join('');
  } catch (error) {
    manejarError(`‚ùå Error al cargar usuarios: ${error.message}`);
  }
}

// ================= FUNCIONES DE CONCEPTOS ================= //
async function agregarConcepto() {
  const nombre = document.getElementById("nuevoConcepto").value.trim();
  if (!nombre) return manejarError("‚ö†Ô∏è Escribe un nombre para el concepto");

  try {
    await db.collection("conceptos").add({ nombre });
    document.getElementById("nuevoConcepto").value = "";
    mostrarMensaje("‚úÖ Concepto creado exitosamente", 'exito');
    cargarConceptos();
  } catch (error) {
    manejarError(`‚ùå Error al crear concepto: ${error.message}`);
  }
}

async function cargarConceptos() {
  try {
    const snapshot = await db.collection("conceptos").get();
    document.getElementById("listaConceptos").innerHTML = snapshot.docs.map(doc => `
      <div class="item">
        <span>${doc.data().nombre}</span>
        <div class="acciones">
          <button onclick="editarConcepto('${doc.id}', '${doc.data().nombre}')">‚úèÔ∏è</button>
          <button onclick="eliminarConcepto('${doc.id}')">üóë</button>
        </div>
      </div>
    `).join('');
  } catch (error) {
    manejarError(`‚ùå Error al cargar conceptos: ${error.message}`);
  }
}

// ================= FUNCIONES DE GASTOS ================= //
async function procesarGasto() {
  const texto = document.getElementById("descripcionGasto").value.trim();
  const mensajeError = document.getElementById("mensajeError");
  
  if (!usuarioSeleccionado) return manejarError("‚ö†Ô∏è Primero selecciona un usuario");
  if (!texto) return manejarError("‚ö†Ô∏è Describe tu gasto");

  try {
    // Obtener lista de conceptos
    const conceptosSnapshot = await db.collection("conceptos").get();
    const conceptos = conceptosSnapshot.docs.map(doc => doc.data().nombre);
    if (conceptos.length === 0) return manejarError("‚ö†Ô∏è Crea conceptos primero");

    // Consultar a OpenAI
    const respuesta = await axios.post(
      'https://api.openai.com/v1/chat/completions',
      {
        model: "gpt-3.5-turbo",
        messages: [{
          role: "user",
          content: `Clasifica este gasto: "${texto}" usando solo estos conceptos: ${conceptos.join(", ")}. Responde SOLO con el concepto.`
        }],
        temperature: 0.7
      },
      {
        headers: {
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );

    const conceptoIA = respuesta.data.choices[0].message.content.trim();
    const monto = parseFloat(texto.match(/\d+/)[0]) || 0;

    // Guardar en Firebase
    await db.collection("gastos").add({
      concepto: conceptoIA,
      monto: monto,
      usuario: usuarioSeleccionado,
      descripcion: texto,
      fecha: new Date().toISOString().split('T')[0]
    });

    document.getElementById("descripcionGasto").value = "";
    mostrarMensaje("‚úÖ Gasto analizado y guardado correctamente", 'exito');
    cargarGastos();

  } catch (error) {
    const mensaje = error.response?.data?.error?.message || error.message;
    manejarError(`‚ùå Error en OpenAI: ${mensaje}`);
  }
}

async function cargarGastos() {
  try {
    const snapshot = await db.collection("gastos").orderBy("fecha", "desc").get();
    document.querySelector("#tablaGastos tbody").innerHTML = snapshot.docs.map(doc => `
      <tr>
        <td>${doc.data().fecha}</td>
        <td>${doc.data().concepto}</td>
        <td>$${doc.data().monto.toFixed(2)}</td>
        <td>${doc.data().descripcion}</td>
        <td>
          <button onclick="editarGasto('${doc.id}')">‚úèÔ∏è</button>
          <button onclick="eliminarGasto('${doc.id}')">üóë</button>
        </td>
      </tr>
    `).join('');
  } catch (error) {
    manejarError(`‚ùå Error al cargar gastos: ${error.message}`);
  }
}

// ================= FUNCIONES AUXILIARES ================= //
function mostrarMensaje(texto, tipo = 'exito') {
  const elemento = tipo === 'exito' 
    ? document.getElementById("mensajeExito")
    : document.getElementById("mensajeError");
  
  elemento.textContent = texto;
  elemento.style.display = 'block';
  setTimeout(() => elemento.style.display = 'none', 3000);
}

function manejarError(mensaje) {
  const elemento = document.getElementById("mensajeError");
  elemento.textContent = mensaje;
  elemento.style.display = 'block';
  console.error(mensaje);
}

// ================= FUNCIONES DE EDICI√ìN ================= //
async function editarUsuario(id, nombreActual) {
  const nuevoNombre = prompt("Nuevo nombre:", nombreActual);
  if (nuevoNombre) {
    try {
      await db.collection("usuarios").doc(id).update({ nombre: nuevoNombre });
      cargarUsuarios();
      mostrarMensaje("‚úÖ Usuario actualizado", 'exito');
    } catch (error) {
      manejarError(`‚ùå Error al editar: ${error.message}`);
    }
  }
}

async function eliminarUsuario(id) {
  if (confirm("¬øEliminar este usuario permanentemente?")) {
    try {
      await db.collection("usuarios").doc(id).delete();
      cargarUsuarios();
      mostrarMensaje("‚úÖ Usuario eliminado", 'exito');
    } catch (error) {
      manejarError(`‚ùå Error al eliminar: ${error.message}`);
    }
  }
}

function seleccionarUsuario(nombre) {
  usuarioSeleccionado = nombre;
  mostrarMensaje(`‚úÖ Usuario activo: ${nombre}`, 'exito');
}
// ================= FUNCIONES DE CONCEPTOS ================= //
async function editarConcepto(id, nombreActual) {
  const nuevoNombre = prompt("Editar concepto:", nombreActual);
  if (nuevoNombre) {
    try {
      await db.collection("conceptos").doc(id).update({ nombre: nuevoNombre });
      cargarConceptos();
      mostrarMensaje("‚úÖ Concepto actualizado", 'exito');
    } catch (error) {
      manejarError(`‚ùå Error al editar: ${error.message}`);
    }
  }
}

async function eliminarConcepto(id) {
  if (confirm("¬øEliminar este concepto permanentemente?")) {
    try {
      await db.collection("conceptos").doc(id).delete();
      cargarConceptos();
      mostrarMensaje("‚úÖ Concepto eliminado", 'exito');
    } catch (error) {
      manejarError(`‚ùå Error al eliminar: ${error.message}`);
    }
  }
}

// ================= FUNCIONES DE GASTOS ================= //
async function editarGasto(id) {
  try {
    const doc = await db.collection("gastos").doc(id).get();
    const nuevoTexto = prompt("Editar descripci√≥n:", doc.data().descripcion);
    if (nuevoTexto) {
      await db.collection("gastos").doc(id).update({ descripcion: nuevoTexto });
      cargarGastos();
      mostrarMensaje("‚úÖ Gasto actualizado", 'exito');
    }
  } catch (error) {
    manejarError(`‚ùå Error al editar: ${error.message}`);
  }
}

async function eliminarGasto(id) {
  if (confirm("¬øEliminar este gasto permanentemente?")) {
    try {
      await db.collection("gastos").doc(id).delete();
      cargarGastos();
      mostrarMensaje("‚úÖ Gasto eliminado", 'exito');
    } catch (error) {
      manejarError(`‚ùå Error al eliminar: ${error.message}`);
    }
  }
}
</script>
</body>
</html>
