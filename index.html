<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gastos Personales</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .topbar { background: #2c3e50; padding: 10px; color: white; }
    button { background: #007bff; color: white; border: none; padding: 8px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    .acciones button { margin: 2px; padding: 4px 8px; }
  </style>
</head>
<body>
  <!-- Pantalla de Login -->
  <div id="login">
    <h2>Ingresa el PIN</h2>
    <form onsubmit="event.preventDefault(); checkPIN()">
      <input type="password" id="pinInput" placeholder="PIN (5351)" required>
      <button type="submit">Entrar</button>
    </form>
  </div>

  <!-- Pantalla Principal -->
  <div id="app" class="hidden">
    <div class="topbar">
      <button onclick="showSection('usuarios')">üë§ Usuarios</button>
      <button onclick="showSection('conceptos')">üóÇÔ∏è Conceptos</button>
      <button onclick="showSection('gastos')">üí∏ Gastos</button>
    </div>

    <!-- Secci√≥n Usuarios -->
    <div id="usuarios" class="section">
      <h3>Usuarios</h3>
      <input type="text" id="newUser" placeholder="Nuevo usuario">
      <button onclick="addUser()">Agregar</button>
      <div id="usersList"></div>
    </div>

    <!-- Secci√≥n Conceptos -->
    <div id="conceptos" class="section hidden">
      <h3>Conceptos</h3>
      <input type="text" id="newConcept" placeholder="Nuevo concepto">
      <button onclick="addConcept()">Agregar</button>
      <div id="conceptList"></div>
    </div>

    <!-- Secci√≥n Gastos -->
    <div id="gastos" class="section hidden">
      <h3>Registrar Gasto</h3>
      <textarea id="gastoTexto" placeholder="Ej: Compr√© pan por $20"></textarea>
      <button onclick="agregarGasto()">Guardar</button>
      <table id="tablaGastos">
        <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Usuario</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
// ========== CONFIGURACI√ìN FIREBASE ========== //
const firebaseConfig = {
  apiKey: "AIzaSyC6UgYa0Qb2TTuvlpxU6nEru4LYKUMu8pQ",
  authDomain: "gastospersonales-96004.firebaseapp.com",
  projectId: "gastospersonales-96004",
  storageBucket: "gastospersonales-96004.appspot.com",
  messagingSenderId: "243343663938",
  appId: "1:243343663938:web:3482c365b6ce580e3cb969"
};

// Inicializar Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(app);
let selectedUser = "";
const OPENAI_API_KEY = "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";

// ========== FUNCIONES PRINCIPALES ========== //
function checkPIN() {
  if (document.getElementById("pinInput").value === "5351") {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    showSection('usuarios');
  } else {
    alert("PIN incorrecto!");
  }
}

function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(div => div.classList.add('hidden'));
  document.getElementById(sectionId).classList.remove('hidden');
  if (sectionId === 'usuarios') cargarUsuarios();
  if (sectionId === 'conceptos') cargarConceptos();
  if (sectionId === 'gastos') cargarGastos();
}

// ========== GESTI√ìN DE USUARIOS ========== //
async function addUser() {
  try {
    const name = document.getElementById("newUser").value.trim();
    if (!name) return;
    await db.collection("usuarios").add({ nombre: name });
    document.getElementById("newUser").value = "";
    cargarUsuarios();
  } catch (error) {
    alert(`Error al crear usuario: ${error.message}`);
  }
}

async function cargarUsuarios() {
  try {
    const snapshot = await db.collection("usuarios").get();
    const cont = document.getElementById("usersList");
    cont.innerHTML = snapshot.docs.map(doc => `
      <div>
        ${doc.data().nombre} 
        <button class="acciones" onclick="editarUsuario('${doc.id}', '${doc.data().nombre}')">‚úèÔ∏è</button>
        <button class="acciones" onclick="eliminarUsuario('${doc.id}')">üóë</button>
        <button class="acciones" onclick="selectedUser = '${doc.data().nombre}'; alert('Usuario seleccionado: ${doc.data().nombre}')">‚úÖ</button>
      </div>
    `).join('');
  } catch (error) {
    alert(`Error al cargar usuarios: ${error.message}`);
  }
}

// ========== GESTI√ìN DE CONCEPTOS ========== //
async function addConcept() {
  try {
    const name = document.getElementById("newConcept").value.trim();
    if (!name) return;
    await db.collection("conceptos").add({ nombre: name });
    document.getElementById("newConcept").value = "";
    cargarConceptos();
  } catch (error) {
    alert(`Error al crear concepto: ${error.message}`);
  }
}

async function cargarConceptos() {
  try {
    const snapshot = await db.collection("conceptos").get();
    document.getElementById("conceptList").innerHTML = snapshot.docs.map(doc => `
      <div>
        ${doc.data().nombre}
        <button class="acciones" onclick="editarConcepto('${doc.id}', '${doc.data().nombre}')">‚úèÔ∏è</button>
        <button class="acciones" onclick="eliminarConcepto('${doc.id}')">üóë</button>
      </div>
    `).join('');
  } catch (error) {
    alert(`Error al cargar conceptos: ${error.message}`);
  }
}

// ========== GESTI√ìN DE GASTOS ========== //
async function agregarGasto() {
  try {
    if (!selectedUser) return alert("¬°Selecciona un usuario primero!");
    const texto = document.getElementById("gastoTexto").value.trim();
    if (!texto) return;

    // Clasificaci√≥n con OpenAI
    const conceptos = (await db.collection("conceptos").get()).docs.map(doc => doc.data().nombre);
    const prompt = `Clasifica: "${texto}" usando solo estos conceptos: ${conceptos.join(", ")}. Responde SOLO con el concepto.`;
    
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${OPENAI_API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: [{ role: "user", content: prompt }]
      })
    });

    const data = await response.json();
    if (!data.choices?.[0]?.message?.content) throw new Error("Respuesta de OpenAI inv√°lida");
    
    const concepto = data.choices[0].message.content.trim();
    const monto = parseFloat(texto.match(/\d+/)[0]) || 0;

    await db.collection("gastos").add({
      concepto,
      monto,
      usuario: selectedUser,
      fecha: new Date().toISOString().split('T')[0],
      texto
    });

    document.getElementById("gastoTexto").value = "";
    cargarGastos();
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

async function cargarGastos() {
  try {
    const snapshot = await db.collection("gastos").orderBy("fecha", "desc").get();
    document.querySelector("#tablaGastos tbody").innerHTML = snapshot.docs.map(doc => `
      <tr>
        <td>${doc.data().fecha}</td>
        <td>${doc.data().concepto}</td>
        <td>$${doc.data().monto}</td>
        <td>${doc.data().usuario}</td>
        <td>
          <button class="acciones" onclick="editarGasto('${doc.id}')">‚úèÔ∏è</button>
          <button class="acciones" onclick="eliminarGasto('${doc.id}')">üóë</button>
        </td>
      </tr>
    `).join('');
  } catch (error) {
    alert(`Error al cargar gastos: ${error.message}`);
  }
}

// ========== FUNCIONES DE EDICI√ìN ========== //
async function editarUsuario(id, oldName) {
  const nuevo = prompt("Nuevo nombre:", oldName);
  if (nuevo) {
    try {
      await db.collection("usuarios").doc(id).update({ nombre: nuevo });
      cargarUsuarios();
    } catch (error) {
      alert(`Error al editar usuario: ${error.message}`);
    }
  }
}

async function eliminarUsuario(id) {
  if (confirm("¬øEliminar usuario?")) {
    try {
      await db.collection("usuarios").doc(id).delete();
      cargarUsuarios();
    } catch (error) {
      alert(`Error al eliminar usuario: ${error.message}`);
    }
  }
}

async function editarConcepto(id, oldName) {
  const nuevo = prompt("Editar concepto:", oldName);
  if (nuevo) {
    try {
      await db.collection("conceptos").doc(id).update({ nombre: nuevo });
      cargarConceptos();
    } catch (error) {
      alert(`Error al editar concepto: ${error.message}`);
    }
  }
}

async function eliminarConcepto(id) {
  if (confirm("¬øEliminar concepto?")) {
    try {
      await db.collection("conceptos").doc(id).delete();
      cargarConceptos();
    } catch (error) {
      alert(`Error al eliminar concepto: ${error.message}`);
    }
  }
}

async function editarGasto(id) {
  try {
    const docRef = await db.collection("gastos").doc(id).get();
    const data = docRef.data();
    const nuevoTexto = prompt("Editar descripci√≥n:", data.texto);
    
    if (nuevoTexto) {
      await db.collection("gastos").doc(id).update({ texto: nuevoTexto });
      cargarGastos();
    }
  } catch (error) {
    alert(`Error al editar gasto: ${error.message}`);
  }
}

async function eliminarGasto(id) {
  if (confirm("¬øEliminar gasto?")) {
    try {
      await db.collection("gastos").doc(id).delete();
      cargarGastos();
    } catch (error) {
      alert(`Error al eliminar gasto: ${error.message}`);
    }
  }
}
</script>
</body>
</html>
