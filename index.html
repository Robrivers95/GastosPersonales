<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor Inteligente Completo</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --color-primario: #2c3e50;
      --color-secundario: #1abc9c;
      --fondo: #f8f9fa;
    }
    body {
      font-family: 'Arial', sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: var(--fondo);
    }
    .hidden { display: none; }
    .topbar {
      background: var(--color-primario);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      background: var(--color-secundario);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { opacity: 0.9; }
    input, textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      border: 1px solid #eee;
      text-align: left;
    }
    th { background: var(--fondo); }
    .alerta {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      display: none;
    }
    .error { background: #ffebee; color: #d32f2f; }
    .exito { background: #e8f5e9; color: #2e7d32; }
    .preview-img {
      max-width: 150px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <!-- Acceso -->
  <div id="login">
    <h2>ğŸ” Acceso al Sistema</h2>
    <input type="password" id="inputPIN" placeholder="PIN (5351)">
    <button onclick="verificarPIN()">Ingresar</button>
    <div id="mensajeError" class="alerta error"></div>
  </div>

  <!-- AplicaciÃ³n -->
  <div id="app" class="hidden">
    <div class="topbar">
      <button onclick="mostrarSeccion('usuarios')">ğŸ‘¥ Usuarios</button>
      <button onclick="mostrarSeccion('conceptos')">ğŸ—ƒï¸ Conceptos</button>
      <button onclick="mostrarSeccion('gastos')">ğŸ’µ Gastos IA</button>
    </div>

    <!-- SecciÃ³n Usuarios -->
    <div id="seccionUsuarios">
      <h3>ğŸ§‘ğŸ’¼ AdministraciÃ³n de Usuarios</h3>
      <input type="text" id="nuevoUsuario" placeholder="Nombre completo">
      <button onclick="agregarUsuario()">â• Crear Usuario</button>
      <div id="listaUsuarios" style="margin-top: 20px;"></div>
    </div>

    <!-- SecciÃ³n Conceptos -->
    <div id="seccionConceptos" class="hidden">
      <h3>ğŸ“‚ GestiÃ³n de Conceptos</h3>
      <input type="text" id="nuevoConcepto" placeholder="Nuevo concepto">
      <button onclick="agregarConcepto()">â• Agregar Concepto</button>
      <div id="listaConceptos" style="margin-top: 20px;"></div>
    </div>

    <!-- SecciÃ³n Gastos con OpenAI -->
    <div id="seccionGastos" class="hidden">
      <h3>ğŸ¤– Registro Inteligente de Gastos</h3>
      <textarea id="descripcionGasto" 
                placeholder="Ej: '15/03 - Compra de materiales $500 en Lerry Merlin para proyecto CasaX - Foto: drive.com/foto1'"
                rows="4"></textarea>
      <input type="file" id="fotoGasto" onchange="previewImage(event)">
      <img id="preview" class="preview-img">
      <button onclick="procesarConOpenAI()">ğŸ§  Procesar con IA</button>
      <div id="mensajeExito" class="alerta exito"></div>
      
      <h4>ğŸ“… Historial de Gastos</h4>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Concepto</th>
            <th>Monto</th>
            <th>Proyecto</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaGastos"></tbody>
      </table>
    </div>
  </div>

<script>
// ================= CONFIGURACIÃ“N INICIAL ================= //
const firebaseConfig = {
  apiKey: "TU_API_KEY_FIREBASE",
  authDomain: "TU_PROYECTO.firebaseapp.com",
  projectId: "TU_PROYECTO",
  storageBucket: "TU_PROYECTO.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:XXXXXX"
};

// AsegÃºrate de poner tu API Key vÃ¡lida de OpenAI aquÃ­
const OPENAI_API_KEY = "sk-xxxxxxxxxxxxxxxxxxxxxxxx";

// Inicializar Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(app);
let usuarioActivo = null;
let imagenBase64 = null;

// ================= FUNCIONES PRINCIPALES ================= //
function verificarPIN() {
  const pin = document.getElementById("inputPIN").value;
  const mensajeError = document.getElementById("mensajeError");
  
  if (pin === "5351") {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    mostrarSeccion('usuarios');
  } else {
    mensajeError.textContent = "âŒ PIN incorrecto. Intenta nuevamente.";
    mensajeError.style.display = 'block';
  }
}

function mostrarSeccion(seccion) {
  document.querySelectorAll('[id^="seccion"]').forEach(el => el.classList.add('hidden'));
  document.getElementById(`seccion${seccion.charAt(0).toUpperCase() + seccion.slice(1)}`).classList.remove('hidden');
  if (seccion === 'usuarios') cargarUsuarios();
  if (seccion === 'conceptos') cargarConceptos();
  if (seccion === 'gastos') cargarGastos();
}

// ================= USUARIOS ================= //
async function agregarUsuario() {
  const nombre = document.getElementById("nuevoUsuario").value.trim();
  if (!nombre) return mostrarError("âš ï¸ Ingresa un nombre vÃ¡lido");
  
  try {
    await db.collection("usuarios").add({ nombre });
    document.getElementById("nuevoUsuario").value = "";
    mostrarExito("âœ… Usuario creado exitosamente");
    cargarUsuarios();
  } catch (error) {
    mostrarError(`âŒ Error: ${error.message}`);
  }
}

async function cargarUsuarios() {
  try {
    const snapshot = await db.collection("usuarios").get();
    const lista = document.getElementById("listaUsuarios");
    lista.innerHTML = snapshot.docs.map(doc => `
      <div class="item">
        <span>${doc.data().nombre}</span>
        <div>
          <button onclick="editarUsuario('${doc.id}', '${doc.data().nombre}')">âœï¸</button>
          <button onclick="eliminarUsuario('${doc.id}')">ğŸ—‘</button>
          <button onclick="seleccionarUsuario('${doc.data().nombre}')">âœ”ï¸ Seleccionar</button>
        </div>
      </div>
    `).join('');
  } catch (error) {
    mostrarError(`âŒ Error al cargar usuarios: ${error.message}`);
  }
}

async function editarUsuario(id, nombreActual) {
  const nuevoNombre = prompt("Nuevo nombre:", nombreActual);
  if (nuevoNombre) {
    try {
      await db.collection("usuarios").doc(id).update({ nombre: nuevoNombre });
      cargarUsuarios();
      mostrarExito("âœ… Usuario actualizado");
    } catch (error) {
      mostrarError(`âŒ Error: ${error.message}`);
    }
  }
}

async function eliminarUsuario(id) {
  if (confirm("Â¿Eliminar este usuario permanentemente?")) {
    try {
      await db.collection("usuarios").doc(id).delete();
      cargarUsuarios();
      mostrarExito("âœ… Usuario eliminado");
    } catch (error) {
      mostrarError(`âŒ Error: ${error.message}`);
    }
  }
}

function seleccionarUsuario(nombre) {
  usuarioActivo = nombre;
  mostrarExito(`âœ… Usuario activo: ${nombre}`);
}

// ================= CONCEPTOS ================= //
async function agregarConcepto() {
  const nombre = document.getElementById("nuevoConcepto").value.trim();
  if (!nombre) return mostrarError("âš ï¸ Ingresa un concepto vÃ¡lido");
  
  try {
    await db.collection("conceptos").add({ nombre });
    document.getElementById("nuevoConcepto").value = "";
    mostrarExito("âœ… Concepto creado exitosamente");
    cargarConceptos();
  } catch (error) {
    mostrarError(`âŒ Error: ${error.message}`);
  }
}

async function cargarConceptos() {
  try {
    const snapshot = await db.collection("conceptos").get();
    const lista = document.getElementById("listaConceptos");
    lista.innerHTML = snapshot.docs.map(doc => `
      <div class="item">
        <span>${doc.data().nombre}</span>
        <div>
          <button onclick="editarConcepto('${doc.id}', '${doc.data().nombre}')">âœï¸</button>
          <button onclick="eliminarConcepto('${doc.id}')">ğŸ—‘</button>
        </div>
      </div>
    `).join('');
  } catch (error) {
    mostrarError(`âŒ Error al cargar conceptos: ${error.message}`);
  }
}

async function editarConcepto(id, nombreActual) {
  const nuevoNombre = prompt("Editar concepto:", nombreActual);
  if (nuevoNombre) {
    try {
      await db.collection("conceptos").doc(id).update({ nombre: nuevoNombre });
      cargarConceptos();
      mostrarExito("âœ… Concepto actualizado");
    } catch (error) {
      mostrarError(`âŒ Error: ${error.message}`);
    }
  }
}

async function eliminarConcepto(id) {
  if (confirm("Â¿Eliminar este concepto permanentemente?")) {
    try {
      await db.collection("conceptos").doc(id).delete();
      cargarConceptos();
      mostrarExito("âœ… Concepto eliminado");
    } catch (error) {
      mostrarError(`âŒ Error: ${error.message}`);
    }
  }
}

// ================= GASTOS CON OPENAI ================= //
function previewImage(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = e => {
    imagenBase64 = e.target.result;
    document.getElementById("preview").src = imagenBase64;
  };
  reader.readAsDataURL(file);
}

async function procesarConOpenAI() {
  const texto = document.getElementById("descripcionGasto").value.trim();
  if (!usuarioActivo) return mostrarError("âš ï¸ Primero selecciona un usuario");
  if (!texto) return mostrarError("âš ï¸ Describe el gasto");
  
  try {
    // Llamada a la API oficial Chat Completions
    const respuesta = await axios.post(
      'https://api.openai.com/v1/chat/completions',
      {
        model: "gpt-3.5-turbo", // Usa GPT-3.5 si no tienes acceso a GPT-4
        messages: [{
          role: "user",
          content: `Extrae en formato JSON: { fecha: "dd/mm/aaaa", concepto: "", monto: 0, proyecto: "" } del texto: "${texto}"`
        }],
        temperature: 0.3
      },
      {
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${OPENAI_API_KEY}`
        }
      }
    );

    // La respuesta vendrÃ¡ en respuesta.data.choices[0].message.content
    const rawText = respuesta.data.choices[0].message.content.trim();
    const datos = JSON.parse(rawText);

    if (!datos.fecha || !datos.concepto || !datos.monto) {
      throw new Error("La IA no pudo extraer todos los datos requeridos");
    }

    // Guardar en Firestore (colecciÃ³n "gastos")
    await db.collection("gastos").add({
      ...datos,
      imagen: imagenBase64,
      usuario: usuarioActivo,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Limpiar formulario
    document.getElementById("descripcionGasto").value = "";
    imagenBase64 = null;
    document.getElementById("preview").src = "";
    
    mostrarExito("âœ… Gasto procesado correctamente");
    cargarGastos();
    
  } catch (error) {
    mostrarError(`âŒ Error: ${error.response?.data?.error?.message || error.message}`);
  }
}

async function cargarGastos() {
  try {
    const snapshot = await db.collection("gastos").orderBy("timestamp", "desc").get();
    document.getElementById("tablaGastos").innerHTML = snapshot.docs.map(doc => {
      const data = doc.data();
      return `
        <tr>
          <td>${data.fecha}</td>
          <td>${data.concepto}</td>
          <td>$${data.monto}</td>
          <td>${data.proyecto}</td>
          <td>
            ${data.imagen ? `<img src="${data.imagen}" class="preview-img">` : ''}
            <button onclick="eliminarGasto('${doc.id}')">ğŸ—‘</button>
          </td>
        </tr>
      `;
    }).join('');
  } catch (error) {
    mostrarError(`âŒ Error al cargar gastos: ${error.message}`);
  }
}

async function eliminarGasto(id) {
  if (confirm("Â¿Eliminar este gasto permanentemente?")) {
    try {
      await db.collection("gastos").doc(id).delete();
      cargarGastos();
      mostrarExito("âœ… Gasto eliminado");
    } catch (error) {
      mostrarError(`âŒ Error: ${error.message}`);
    }
  }
}

// ================= FUNCIONES AUXILIARES ================= //
function mostrarError(mensaje) {
  const elemento = document.getElementById("mensajeError");
  elemento.textContent = mensaje;
  elemento.style.display = 'block';
  setTimeout(() => elemento.style.display = 'none', 5000);
}

function mostrarExito(mensaje) {
  const elemento = document.getElementById("mensajeExito");
  elemento.textContent = mensaje;
  elemento.style.display = 'block';
  setTimeout(() => elemento.style.display = 'none', 3000);
}
</script>
</body>
</html>
