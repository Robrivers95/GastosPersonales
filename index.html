<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gastos Personales</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .topbar { background: #2c3e50; padding: 10px; color: white; }
    button { background: #007bff; color: white; border: none; padding: 8px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
  </style>
</head>
<body>
  <!-- Pantalla de Login -->
  <div id="login">
    <h2>Ingresa el PIN</h2>
    <input type="password" id="pinInput" placeholder="PIN (5351)">
    <button onclick="checkPIN()">Entrar</button>
  </div>

  <!-- Pantalla Principal -->
  <div id="app" class="hidden">
    <div class="topbar">
      <button onclick="showSection('usuarios')">ğŸ‘¤ Usuarios</button>
      <button onclick="showSection('conceptos')">ğŸ—‚ï¸ Conceptos</button>
      <button onclick="showSection('gastos')">ğŸ’¸ Gastos</button>
    </div>

    <!-- SecciÃ³n Usuarios -->
    <div id="usuarios" class="section">
      <h3>Usuarios</h3>
      <input type="text" id="newUser" placeholder="Nuevo usuario">
      <button onclick="addUser()">Agregar</button>
      <div id="usersList"></div>
    </div>

    <!-- SecciÃ³n Conceptos -->
    <div id="conceptos" class="section hidden">
      <h3>Conceptos</h3>
      <input type="text" id="newConcept" placeholder="Nuevo concepto">
      <button onclick="addConcept()">Agregar</button>
      <div id="conceptList"></div>
    </div>

    <!-- SecciÃ³n Gastos -->
    <div id="gastos" class="section hidden">
      <h3>Registrar Gasto</h3>
      <textarea id="gastoTexto" placeholder="Ej: ComprÃ© pan por $20"></textarea>
      <button onclick="agregarGasto()">Guardar</button>
      <table id="tablaGastos">
        <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Usuario</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
// ========== CONFIGURACIÃ“N FIREBASE ========== //
const firebaseConfig = {
  apiKey: "AIzaSyC6UgYa0Qb2TTuvlpxU6nEru4LYKUMu8pQ",
  authDomain: "gastospersonales-96004.firebaseapp.com",
  projectId: "gastospersonales-96004",
  storageBucket: "gastospersonales-96004.appspot.com",
  messagingSenderId: "243343663938",
  appId: "1:243343663938:web:3482c365b6ce580e3cb969"
};

// Inicializar Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(app);
let selectedUser = "";
const OPENAI_API_KEY = "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";

// ========== FUNCIONES PRINCIPALES ========== //
function checkPIN() {
  if (document.getElementById("pinInput").value === "5351") {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    showSection('usuarios');
  } else {
    alert("PIN incorrecto!");
  }
}

function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(div => div.classList.add('hidden'));
  document.getElementById(sectionId).classList.remove('hidden');
  if (sectionId === 'usuarios') cargarUsuarios();
  if (sectionId === 'conceptos') cargarConceptos();
  if (sectionId === 'gastos') cargarGastos();
}

// ========== GESTIÃ“N DE USUARIOS ========== //
async function addUser() {
  const name = document.getElementById("newUser").value.trim();
  if (!name) return;
  await db.collection("usuarios").add({ nombre: name });
  document.getElementById("newUser").value = "";
  cargarUsuarios();
}

async function cargarUsuarios() {
  const snapshot = await db.collection("usuarios").get();
  const cont = document.getElementById("usersList");
  cont.innerHTML = snapshot.docs.map(doc => `
    <div>${doc.data().nombre} 
      <button onclick="editarUsuario('${doc.id}', '${doc.data().nombre}')">âœï¸</button>
      <button onclick="eliminarUsuario('${doc.id}')">ğŸ—‘</button>
      <button onclick="selectedUser = '${doc.data().nombre}'; alert('Usuario seleccionado')">âœ…</button>
    </div>
  `).join('');
}

async function editarUsuario(id, oldName) {
  const nuevo = prompt("Nuevo nombre:", oldName);
  if (nuevo) await db.collection("usuarios").doc(id).update({ nombre: nuevo });
  cargarUsuarios();
}

async function eliminarUsuario(id) {
  if (confirm("Â¿Eliminar usuario?")) await db.collection("usuarios").doc(id).delete();
  cargarUsuarios();
}

// ========== GESTIÃ“N DE CONCEPTOS ========== //
async function addConcept() {
  const name = document.getElementById("newConcept").value.trim();
  if (!name) return;
  await db.collection("conceptos").add({ nombre: name });
  document.getElementById("newConcept").value = "";
  cargarConceptos();
}

async function cargarConceptos() {
  const snapshot = await db.collection("conceptos").get();
  document.getElementById("conceptList").innerHTML = snapshot.docs.map(doc => `
    <div>${doc.data().nombre}
      <button onclick="editarConcepto('${doc.id}', '${doc.data().nombre}')">âœï¸</button>
      <button onclick="eliminarConcepto('${doc.id}')">ğŸ—‘</button>
    </div>
  `).join('');
}

async function editarConcepto(id, oldName) {
  const nuevo = prompt("Editar concepto:", oldName);
  if (nuevo) await db.collection("conceptos").doc(id).update({ nombre: nuevo });
  cargarConceptos();
}

async function eliminarConcepto(id) {
  if (confirm("Â¿Eliminar concepto?")) await db.collection("conceptos").doc(id).delete();
  cargarConceptos();
}

// ========== GESTIÃ“N DE GASTOS ========== //
async function agregarGasto() {
  if (!selectedUser) return alert("Â¡Selecciona un usuario primero!");
  const texto = document.getElementById("gastoTexto").value.trim();
  if (!texto) return;

  // ClasificaciÃ³n con OpenAI
  const conceptos = (await db.collection("conceptos").get()).docs.map(doc => doc.data().nombre);
  const prompt = `Clasifica: "${texto}" usando solo estos conceptos: ${conceptos.join(", ")}. Responde SOLO con el concepto.`;
  
  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${OPENAI_API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: "gpt-3.5-turbo",
      messages: [{ role: "user", content: prompt }]
    })
  });

  const data = await response.json();
  const concepto = data.choices[0].message.content.trim();
  const monto = parseFloat(texto.match(/\d+/)[0]) || 0;

  await db.collection("gastos").add({
    concepto,
    monto,
    usuario: selectedUser,
    fecha: new Date().toISOString().split('T')[0],
    texto
  });

  document.getElementById("gastoTexto").value = "";
  cargarGastos();
}

async function cargarGastos() {
  const snapshot = await db.collection("gastos").orderBy("fecha", "desc").get();
  document.querySelector("#tablaGastos tbody").innerHTML = snapshot.docs.map(doc => `
    <tr>
      <td>${doc.data().fecha}</td>
      <td>${doc.data().concepto}</td>
      <td>$${doc.data().monto}</td>
      <td>${doc.data().usuario}</td>
      <td><button onclick="eliminarGasto('${doc.id}')">ğŸ—‘</button></td>
    </tr>
  `).join('');
}

async function eliminarGasto(id) {
  if (confirm("Â¿Eliminar gasto?")) await db.collection("gastos").doc(id).delete();
  cargarGastos();
}
</script>
</body>
</html>
