<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gastos Personales</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
    .hidden { display: none; }
    .topbar { background: #2c3e50; padding: 10px; color: white; margin-bottom: 20px; }
    button { background: #007bff; color: white; border: none; padding: 8px 15px; margin: 5px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    input, textarea { width: 300px; padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; }
    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #f8f9fa; }
    .acciones button { margin: 0 3px; padding: 4px 8px; font-size: 14px; }
  </style>
</head>
<body>
  <!-- Pantalla de Login -->
  <div id="login">
    <h2>ğŸ”’ Ingresa el PIN</h2>
    <form onsubmit="event.preventDefault(); checkPIN()">
      <input type="password" id="pinInput" placeholder="PIN (5351)" required>
      <button type="submit">Entrar</button>
    </form>
  </div>

  <!-- Pantalla Principal -->
  <div id="app" class="hidden">
    <div class="topbar">
      <button onclick="showSection('usuarios')">ğŸ‘¤ Usuarios</button>
      <button onclick="showSection('conceptos')">ğŸ—‚ï¸ Conceptos</button>
      <button onclick="showSection('gastos')">ğŸ’¸ Gastos</button>
    </div>

    <!-- SecciÃ³n Usuarios -->
    <div id="usuarios" class="section">
      <h3>ğŸ‘¥ Administrar Usuarios</h3>
      <input type="text" id="newUser" placeholder="Nombre de usuario">
      <button onclick="addUser()">â• Agregar</button>
      <div id="usersList" style="margin-top: 15px;"></div>
    </div>

    <!-- SecciÃ³n Conceptos -->
    <div id="conceptos" class="section hidden">
      <h3>ğŸ“‘ Administrar Conceptos</h3>
      <input type="text" id="newConcept" placeholder="Nuevo concepto">
      <button onclick="addConcept()">â• Agregar</button>
      <div id="conceptList" style="margin-top: 15px;"></div>
    </div>

    <!-- SecciÃ³n Gastos -->
    <div id="gastos" class="section hidden">
      <h3>ğŸ’° Registrar Gastos</h3>
      <textarea id="gastoTexto" placeholder="Ej: ComprÃ© gasolina por $250 pesos" style="width: 100%; height: 80px;"></textarea>
      <button onclick="agregarGasto()">ğŸ’¾ Guardar Gasto</button>
      <h4 style="margin-top: 20px;">ğŸ“‹ Historial de Gastos</h4>
      <table id="tablaGastos">
        <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Usuario</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
// ========== CONFIGURACIÃ“N FIREBASE (NO MODIFICAR) ========== //
const firebaseConfig = {
  apiKey: "AIzaSyC6UgYa0Qb2TTuvlpxU6nEru4LYKUMu8pQ",
  authDomain: "gastospersonales-96004.firebaseapp.com",
  projectId: "gastospersonales-96004",
  storageBucket: "gastospersonales-96004.appspot.com",
  messagingSenderId: "243343663938",
  appId: "1:243343663938:web:3482c365b6ce580e3cb969"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(app);
const OPENAI_API_KEY = "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";
let selectedUser = "";

// ========== FUNCIONES PRINCIPALES ========== //
function checkPIN() {
  const pin = document.getElementById("pinInput").value;
  if (pin === "5351") {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    showSection('usuarios');
  } else {
    alert("âŒ PIN incorrecto. Intenta nuevamente.");
  }
}

function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(div => div.classList.add('hidden'));
  document.getElementById(sectionId).classList.remove('hidden');
  if (sectionId === 'usuarios') cargarUsuarios();
  if (sectionId === 'conceptos') cargarConceptos();
  if (sectionId === 'gastos') cargarGastos();
}

// ========== GESTIÃ“N DE USUARIOS ========== //
async function addUser() {
  const name = document.getElementById("newUser").value.trim();
  if (!name) return alert("âš ï¸ Escribe un nombre de usuario");
  try {
    await db.collection("usuarios").add({ nombre: name });
    document.getElementById("newUser").value = "";
    cargarUsuarios();
    alert("âœ… Usuario creado correctamente");
  } catch (error) {
    alert(`âŒ Error al crear usuario: ${error.message}`);
  }
}

async function cargarUsuarios() {
  try {
    const snapshot = await db.collection("usuarios").get();
    const cont = document.getElementById("usersList");
    cont.innerHTML = snapshot.docs.map(doc => `
      <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
        ${doc.data().nombre}
        <button onclick="editarUsuario('${doc.id}', '${doc.data().nombre}')">âœï¸ Editar</button>
        <button onclick="eliminarUsuario('${doc.id}')">ğŸ—‘ Eliminar</button>
        <button onclick="selectedUser = '${doc.data().nombre}'; alert('âœ… Usuario seleccionado: ${doc.data().nombre}')">âœ”ï¸ Seleccionar</button>
      </div>
    `).join('');
  } catch (error) {
    alert(`âŒ Error al cargar usuarios: ${error.message}`);
  }
}

// ========== GESTIÃ“N DE CONCEPTOS ========== //
async function addConcept() {
  const name = document.getElementById("newConcept").value.trim();
  if (!name) return alert("âš ï¸ Escribe un nombre para el concepto");
  try {
    await db.collection("conceptos").add({ nombre: name });
    document.getElementById("newConcept").value = "";
    cargarConceptos();
    alert("âœ… Concepto creado correctamente");
  } catch (error) {
    alert(`âŒ Error al crear concepto: ${error.message}`);
  }
}

async function cargarConceptos() {
  try {
    const snapshot = await db.collection("conceptos").get();
    document.getElementById("conceptList").innerHTML = snapshot.docs.map(doc => `
      <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
        ${doc.data().nombre}
        <button onclick="editarConcepto('${doc.id}', '${doc.data().nombre}')">âœï¸ Editar</button>
        <button onclick="eliminarConcepto('${doc.id}')">ğŸ—‘ Eliminar</button>
      </div>
    `).join('');
  } catch (error) {
    alert(`âŒ Error al cargar conceptos: ${error.message}`);
  }
}

// ========== GESTIÃ“N DE GASTOS ========== //
async function agregarGasto() {
  if (!selectedUser) return alert("âš ï¸ Primero selecciona un usuario");
  const texto = document.getElementById("gastoTexto").value.trim();
  if (!texto) return alert("âš ï¸ Escribe una descripciÃ³n del gasto");
  
  try {
    // Obtener conceptos
    const conceptosSnapshot = await db.collection("conceptos").get();
    const conceptos = conceptosSnapshot.docs.map(doc => doc.data().nombre);
    if (conceptos.length === 0) return alert("âš ï¸ Primero crea algunos conceptos");
    
    // Clasificar con IA
    const prompt = `Clasifica este gasto: "${texto}" usando solo estos conceptos: ${conceptos.join(", ")}. Responde SOLO con el concepto.`;
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${OPENAI_API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: [{ role: "user", content: prompt }],
        temperature: 0.7
      })
    });
    
    if (!response.ok) throw new Error(`Error de OpenAI: ${response.status}`);
    
    const data = await response.json();
    const concepto = data.choices[0].message.content.trim();
    const monto = parseFloat(texto.match(/\d+/)[0]) || 0;

    // Guardar en Firebase
    await db.collection("gastos").add({
      concepto,
      monto,
      usuario: selectedUser,
      fecha: new Date().toISOString().split('T')[0],
      texto
    });
    
    document.getElementById("gastoTexto").value = "";
    cargarGastos();
    alert("âœ… Gasto registrado correctamente");
    
  } catch (error) {
    alert(`âŒ Error: ${error.message}`);
    console.error(error);
  }
}

async function cargarGastos() {
  try {
    const snapshot = await db.collection("gastos").orderBy("fecha", "desc").get();
    document.querySelector("#tablaGastos tbody").innerHTML = snapshot.docs.map(doc => `
      <tr>
        <td>${doc.data().fecha}</td>
        <td>${doc.data().concepto}</td>
        <td>$${doc.data().monto.toFixed(2)}</td>
        <td>${doc.data().usuario}</td>
        <td>
          <button onclick="editarGasto('${doc.id}')">âœï¸</button>
          <button onclick="eliminarGasto('${doc.id}')">ğŸ—‘</button>
        </td>
      </tr>
    `).join('');
  } catch (error) {
    alert(`âŒ Error al cargar gastos: ${error.message}`);
  }
}

// ========== FUNCIONES DE EDICIÃ“N/ELIMINACIÃ“N ========== //
async function editarUsuario(id, oldName) {
  const nuevo = prompt("âœï¸ Editar usuario:", oldName);
  if (nuevo) {
    try {
      await db.collection("usuarios").doc(id).update({ nombre: nuevo });
      cargarUsuarios();
      alert("âœ… Usuario actualizado");
    } catch (error) {
      alert(`âŒ Error al editar: ${error.message}`);
    }
  }
}

async function eliminarUsuario(id) {
  if (confirm("Â¿Seguro que quieres eliminar este usuario?")) {
    try {
      await db.collection("usuarios").doc(id).delete();
      cargarUsuarios();
      alert("âœ… Usuario eliminado");
    } catch (error) {
      alert(`âŒ Error al eliminar: ${error.message}`);
    }
  }
}

async function editarConcepto(id, oldName) {
  const nuevo = prompt("âœï¸ Editar concepto:", oldName);
  if (nuevo) {
    try {
      await db.collection("conceptos").doc(id).update({ nombre: nuevo });
      cargarConceptos();
      alert("âœ… Concepto actualizado");
    } catch (error) {
      alert(`âŒ Error al editar: ${error.message}`);
    }
  }
}

async function eliminarConcepto(id) {
  if (confirm("Â¿Seguro que quieres eliminar este concepto?")) {
    try {
      await db.collection("conceptos").doc(id).delete();
      cargarConceptos();
      alert("âœ… Concepto eliminado");
    } catch (error) {
      alert(`âŒ Error al eliminar: ${error.message}`);
    }
  }
}

async function eliminarGasto(id) {
  if (confirm("Â¿Seguro que quieres eliminar este gasto?")) {
    try {
      await db.collection("gastos").doc(id).delete();
      cargarGastos();
      alert("âœ… Gasto eliminado");
    } catch (error) {
      alert(`âŒ Error al eliminar: ${error.message}`);
    }
  }
}

async function editarGasto(id) {
  try {
    const doc = await db.collection("gastos").doc(id).get();
    const nuevoTexto = prompt("âœï¸ Editar descripciÃ³n del gasto:", doc.data().texto);
    if (nuevoTexto) {
      await db.collection("gastos").doc(id).update({ texto: nuevoTexto });
      cargarGastos();
      alert("âœ… Gasto actualizado");
    }
  } catch (error) {
    alert(`âŒ Error al editar: ${error.message}`);
  }
}
</script>
</body>
</html>
